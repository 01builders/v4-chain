name: Protobuf
# Protobuf ensures our generated go files match the protos
on:  # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
      - master
      - 'release/v[0-9]+.x'  # e.g. release/v1.x
      - 'release/[a-z]+/v[0-9]+.x'  # e.g. release/ibctestnet/v1.x
      - 'release/v[0-9]+.[0-9]+.x'  # e.g. release/v0.0.x
jobs:
  # Verify protos were generated with `make proto-gen`
  verify-proto-gen:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/cosmos/proto-builder:0.11.5
      options: --user root
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.GH_REPO_READ_TOKEN }}
      - run: git config --global --add safe.directory /__w/v4/v4
      - run: make proto-gen-without-container && git diff --exit-code
  # The submodule commit is an ancestor of the main branch, not some random commit
  submodule-commit-is-ancestor-of-main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.GH_REPO_READ_TOKEN }}
      - name: Submodule commit is ancestor of main
        run: |
          git config --global --add safe.directory /__w/v4/v4
          cd proto
          git fetch --unshallow origin main
          git merge-base --is-ancestor HEAD origin/main
